<!--
InLiveTw : ChromeCast news, events, video streaming through Chrome browser extension.
Part of the programme is derived from 
https://github.com/googlecast/CastHelloText-chrome
-->
<!DOCTYPE html>
<html>
<head>
<title>InLiveTw - ChromeCast - Chrome</title>
<style type="text/css">
#status {
  background-color: #CCC;
  font-size: 12px;
  padding-left: 2em;
}
.livebroadcast { 
  margin-bottom: 1em;
  display: block;
}
.live-logo {
  border: 0;
  float: left;
}
.live-title {
  font-weight: bold;
  font-size: 16px;
  font-family: verdana;
  color: black;
}
.live-loc { 
  font-weight: normal;
  font-size: 12px;
  font-family: helvetica;
  color: #444;
}
.live-type { 
  font-size: 12px;
  cursor: pointer;
}
</style>
<script type="text/javascript" src="//www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script>
<script type="text/javascript">
var applicationID = 'DAA73782';
var namespace = 'urn:x-cast:tw.idv.miaoski.inlivetw';
var session = null;

// 
// Call initialization for Cast
//
if (!chrome.cast || !chrome.cast.isAvailable) {
  setTimeout(initializeCastApi, 1000);
}

function initializeCastApi() {
  var sessionRequest = new chrome.cast.SessionRequest(applicationID);
  var apiConfig = new chrome.cast.ApiConfig(sessionRequest,
    sessionListener,
    receiverListener);

  chrome.cast.initialize(apiConfig, onInitSuccess, onError);
};

function onInitSuccess() {
  console.log("onInitSuccess");
  $('#status').html('ChromeCast 初始化成功');
}

function onError(message) {
  console.log("onError: "+JSON.stringify(message));
  $('#status').html('ChromeCast 錯誤');
}

function onSuccess(message) {
  console.log("onSuccess: "+message);
}

function onStopAppSuccess() {
  console.log('onStopAppSuccess');
  $('#status').html('ChromeCast 已斷開');
}

function launchApp() {
  console.log("launching app...");
  $('#status').html('ChromeCast 連接中...');
  chrome.cast.requestSession(sessionListener, onLaunchError);
}

function sessionListener(e) {
  console.log('New session ID:' + e.sessionId);
  $('#status').html('已接上 ChromeCast.');
  session = e;
  session.addUpdateListener(sessionUpdateListener);  
  session.addMessageListener(namespace, receiverMessage);
}

function sessionUpdateListener(isAlive) {
  var message = isAlive ? 'Session Updated' : 'Session Removed';
  message += ': ' + session.sessionId;
  console.log(message);
  if (!isAlive) {
    session = null;
  }
};

function receiverMessage(namespace, message) {
  console.log("receiverMessage: "+namespace+", "+message);
};

function receiverListener(e) {
  if( e === 'available' ) {
    console.log("receiver found");
    $('#status').html('請連接 ChromeCast.');
  }
  else {
    console.log("receiver list empty");
    $('#status').html('未發現 ChromeCast.');
  }
}

function stopApp() {
  session.stop(onStopAppSuccess, onError);
}

function onLaunchError() {
  console.log("launch error");
}

function sendMessage(message) {
  if (session!=null) {
    session.sendMessage(namespace, message, onSuccess.bind(this, "Message sent: " + message), onError);
  }
  else {
    chrome.cast.requestSession(function(e) {
        session = e;
        session.sendMessage(namespace, message, onSuccess.bind(this, "Message sent: " + message), onError);
      }, onError);
  }
}

function castYT(uri) {
  var p = uri.indexOf('/embed/');
  uri = uri.slice(p + 7, p + 18);
  console.log('cast-live:'+uri);
  sendMessage('cast-live:'+uri);
}

var liveBroadcastQueue = [];
function updateLive(data) {
  liveBroadcastQueue = [];
  for(var i in data) {
    var x = data[i];
    if(x['type'] != 'youtube') {
      var uri = '<div class="live-type">尚未支援 ' + x['type'] + ', 請用瀏覽器播放。</div>';
    } else {
      if(x['embed'] != undefined) {
        var uri = '<div class="live-type" onClick="castYT(' +"'"+x['embed']+"'" + ');"><img src="chromecast-icon.png" width="24" height="24" />播放YouTube</div>';
      } else {
        var uri = '<div class="live-type">沒有 embed 的 YouTube 影片</div>';
      }
    }
    var c = '<div class="livebroadcast">\n';
    if(x['logo'] != undefined)
      c += '<img class="live-logo" width="48" height="48" src="' + x['logo'] + '" />\n';
    if(x['title'] != undefined)
      c += '<div class="live-title">' + x['title'] + '</div>\n';
    if(x['location'] != undefined) {
      c += '<div class="live-loc">' + x['location'] + '</div>\n';
    } else {
      c += '<br />\n';
    }
    c += uri + '</div>\n';
    liveBroadcastQueue.push(c);
  }
  if(liveBroadcastQueue.length == 0) {
    $('#divlive').html('目前無直播頻道');
  } else {
    var lives = '';
    for(var i = 0; i < liveBroadcastQueue.length; i++) {
      lives = lives + liveBroadcastQueue[i] + '\n'; 
    }
    $('#divlive').html(lives);
  }
}

function loadLive() {
  console.log('Loading live');
  $.ajax({
    url: 'https://livelink.firebaseio.com/live/.json',
    // url: 'http://localhost/cast/inLiveTwTextChrome/test-live.json',
    type: 'GET',
    dataType: 'json',
    cache: false,
    success: updateLive,
    error: function(e) {
      $('#live').html('載入失敗，請稍候再試。');
      console.log('Error reading JSON: ' + str(e));
    },
  });
}
</script>
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
</head>
<body>
  <div>
  <input type="button" id="launch" value="連接 ChromeCast" onClick="launchApp();" /><br>
  <input type="button" id="stopapp" value="斷開 ChromeCast" onClick="stopApp();" /><br>
  <input type="button" id="event" value="事件" onClick="sendMessage('cast-events');" /><br>
  <input type="button" id="news" value="報導"  onClick="sendMessage('cast-news');" /><br>
  <input type="button" id="stop" value="停止" onClick="sendMessage('cast-stop');" /><br>
  </div>
  <div id="status"></div>
  <p>直播：</p>
  <div id="divlive">載入中...</div>
<script language="JavaScript">
loadLive();
</script>
</body>
</html>
