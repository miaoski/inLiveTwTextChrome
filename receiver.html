<!--
InLiveTw : Display text message on ChromeCast through Chrome browser extension.
Part of the programme is derived from 
https://github.com/googlecast/CastHelloText-chrome
-->
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <style type="text/css">
      body {
        overflow:hidden;
      }
      div{
        height:720PX;
        width:1280PX;
        padding-left: 36px; 
        padding-right: 36px; 
        text-align:center;
        border:0px solid silver;
        display: table-cell;
        vertical-align:middle;
        color:#FFFFFF;
        background-color:#000000;
        font-weight:normal;
        font-family:Verdana, Geneva, sans-serif;
        font-size:40px;
      }
      #logo_span {
        position: absolute;
        top: 0;
        left: 0;
    padding-top: 48px;
    padding-left: 48px;
        color: #FF0000;
        font-weight: bold;
        font-family: Helvetica;
        font-size: 16px;
    display: inline;
      }
      #last_update {
        font-family: Helvetica;
        font-size: 16px;
        color: #FFFFFF;
        font-weight: normal;
      }
      #logo {
    width: 32px;
    height: 32px;
        vertical-align:middle;
      }
    </style>
    <title>inLIve.TW</title>
  </head>
  <body>
    <span id="logo_span"><img src="//googledrive.com/host/0B0MapJ-Wf54NOTJVTzNnQmRzRzA/logo-black.png" id="logo" />InLive.Tw <span id="last_update">(尚未載入)</span></span>
    <DIV id="message">inLiveTw</DIV>
    <script type="text/javascript" src="//www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver.js"></script>
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="//googledrive.com/host/0B0MapJ-Wf54NOTJVTzNnQmRzRzA/moment.min.js"></script>
    <script type="text/javascript">
      window.onload = function() {
        cast.receiver.logger.setLevelValue(0);
        window.castReceiverManager = cast.receiver.CastReceiverManager.getInstance();
        console.log('Starting Receiver Manager');
        
        // handler for the 'ready' event
        castReceiverManager.onReady = function(event) {
          console.log('Received Ready event: ' + JSON.stringify(event.data));
          window.castReceiverManager.setApplicationState("Application status is ready...");
        };
        
        // handler for 'senderconnected' event
        castReceiverManager.onSenderConnected = function(event) {
          console.log('Received Sender Connected event: ' + event.data);
          console.log(window.castReceiverManager.getSender(event.data).userAgent);
        };
        
        // handler for 'senderdisconnected' event
        castReceiverManager.onSenderDisconnected = function(event) {
          console.log('Received Sender Disconnected event: ' + event.data);
          if (window.castReceiverManager.getSenders().length == 0) {
            window.close();
          }
        };
        
        // handler for 'systemvolumechanged' event
        castReceiverManager.onSystemVolumeChanged = function(event) {
          console.log('Received System Volume Changed event: ' + event.data['level'] + ' ' +
              event.data['muted']);
        };

        // create a CastMessageBus to handle messages for a custom namespace
        window.messageBus =
          window.castReceiverManager.getCastMessageBus(
              'urn:x-cast:tw.idv.miaoski.inlivetw');

        // handler for the CastMessageBus message event
        window.messageBus.onMessage = function(event) {
          console.log('Message [' + event.senderId + ']: ' + event.data);
          if(event.data == 'cast-news') {
            stopInterval();
            loadNews();
          } else if(event.data == 'cast-events') {
            stopInterval();
            loadEvents();
          } else if(event.data == 'cast-stop') {
            stopInterval();
            displayText("已停止播放");
          } else {
            displayText('Got unknown msg: ' + event.data);
          }
          // display the message from the sender
          // displayText(event.data);
          // inform all senders on the CastMessageBus of the incoming message event
          // sender message listener will be invoked
          window.messageBus.send(event.senderId, event.data);
        }

        // initialize the CastReceiverManager with an application status message
        window.castReceiverManager.start({statusText: "Application is starting"});
        console.log('Receiver Manager started');
      };
      
      // utility function to display the text message in the input field
      function displayText(text) {
        // console.log(text);
        document.getElementById("message").innerHTML=text;
        window.castReceiverManager.setApplicationState(text);
      };

//
// InLiveTw : ChromeCast news, events, video streaming through Chrome browser extension.
//

var eventQueue = [];
var queuePointer = 0;
var intervalFlag = null;
var timeoutFlag = null;
var last_update = '';
var updateFrequency = 5*60*1000;    // 5 min

function simpleDateFormatter(jsondt) {
  var dt = jsondt.slice(0, 19).replace('T', ' ');
  return dt;
}

function setLastUpdate() {
  var x = new Date();
  last_update = moment().format('YYYY-MM-DD hh:mm:ss');
}

function updateEvent(data) {
  stopInterval();
  setLastUpdate();
  timeoutFlag = setTimeout('loadEvents()', updateFrequency);
  eventQueue = [];
  for(var id in data) {
    var x = data[id];
    eventQueue.push({
      'dt': x['start'],
      'content': x['title'] + '<br>\n' +
      '<span style="font-size:32px;">'+x['location'] + '</span><br>\n' +
      '<span style="font-size:24px;">'+simpleDateFormatter(x['start'])+'</span>'});
  }

  eventQueue.sort(function (a, b) { // ascendant order
    if(a['dt'] < b['dt']) return -1;
    if(a['dt'] > b['dt']) return 1;
    return 0;
  });
  queuePointer = 0;
  intervalFlag = setInterval(update, 5000);
}

function update() {
  console.log('update()');
  msg = eventQueue[queuePointer % eventQueue.length].content;
  displayText(msg);
  $('#last_update').html('最後更新: ' + last_update);
  queuePointer++;
}

var now = Date.now();
function newsTooOld(jsondt) {
  // One week = too old
  return Date.parse(jsondt) < now - 1000*86400*7;
}

function shortMessage(msg) {
  // Show 140 characters? XDDD
  if(msg.length > 140) {
    return msg.slice(0, 139) + '...';
  } else {
    return msg;
  }
}

function updateNews(data) {
  stopInterval();
  setLastUpdate();
  timeoutFlag = setTimeout('loadNews()', updateFrequency);
  eventQueue = [];
  for(var reporter in data) {
    for(var i = 0; i < data[reporter]['post'].length; i++) {
      var x = data[reporter]['post'][i];
      if(!newsTooOld(x['datetime'])) {
        eventQueue.push({
          'dt': x['datetime'],
          'content': 
            '<span style="font-size:16px;">' + simpleDateFormatter(x['datetime']) + '</span><br>\n' +
            '<span style="font-size:24px;">' + shortMessage(x['message']) + '</span><br>\n' +
            '<img src="'+x['picture']+'">'});
      }
    }
  }

  if(eventQueue.length == 0) {  // When news is way too old ...
    return false;
  }

  eventQueue.sort(function (a, b) { // ascendant order
    if(a['dt'] < b['dt']) return -1;
    if(a['dt'] > b['dt']) return 1;
    return 0;
  });
  queuePointer = 0;
  intervalFlag = setInterval(update, 5000);
}

function debugMessage(str) {
  console.log(str);
}

function loadEvents() {
  debugMessage('Loading events');
  displayText("更新中...");
  $.ajax({
    url: 'https://livelink.firebaseio.com/event/.json',
    type: 'GET',
    dataType: 'json',
    cache: false,
    success: updateEvent,
    error: function(e) {
      displayText('Error reading JSON: ' + str(e));
    },
  });
}

function loadNews() {
  debugMessage('Loading news');
  displayText("載入中...");
  $.ajax({
    url: 'https://livelink.firebaseio.com/news/.json',
    type: 'GET',
    dataType: 'json',
    cache: false,
    success: updateNews,
    error: function(e) {
      displayText('Error reading JSON: ' + str(e));
    },
  });
}

function stopInterval() {
  if(intervalFlag != null) {
    debugMessage('Clear interval');
    clearInterval(intervalFlag);
    intervalFlag = null;
  }
  if(timeoutFlag != null) {
    debugMessage('Clear timeout');
    clearTimeout(timeoutFlag);
    timeoutFlag = null;
  }
}
    </script>
  </body>
</html>
