<!--
InLiveTw : Display text message on ChromeCast through Chrome browser extension.
Part of the programme is derived from 
https://github.com/googlecast/CastHelloText-chrome
-->
<!DOCTYPE html>
<html>
<head>
<title>InLiveTw - ChromeCast - Chrome</title>
<style type="text/css">
html, body, #wrapper {
   height:100%;
   width: 100%;
   margin: 0;
   padding: 0;
   border: 0;
}
#wrapper td {
   vertical-align: middle;
   text-align: center;
}
#input {
  font-family: "Arial", Arial, sans-serif;
  font-size: 40px;
  font-weight: normal;
  text-align: left;
}
.border {
    border: 2px solid #cccccc;
    border-radius: 5px;
    border-color: #8ecaed;
    box-shadow: 0 0 5px #8ecaed;
    outline: none;
}
</style>
<script type="text/javascript" src="//www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script>
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script type="text/javascript">
var applicationID = 'DAA73782';
var namespace = 'urn:x-cast:idv.miaoski.tw.inlivetwtext';
var session = null;

// 
// Call initialization for Cast
//
if (!chrome.cast || !chrome.cast.isAvailable) {
  setTimeout(initializeCastApi, 1000);
}

function initializeCastApi() {
  var sessionRequest = new chrome.cast.SessionRequest(applicationID);
  var apiConfig = new chrome.cast.ApiConfig(sessionRequest,
    sessionListener,
    receiverListener);

  chrome.cast.initialize(apiConfig, onInitSuccess, onError);
};

function onInitSuccess() {
  debugMessage("onInitSuccess");
}

function onError(message) {
  debugMessage("onError: "+JSON.stringify(message));
}

function onSuccess(message) {
  debugMessage("onSuccess: "+message);
}

function onStopAppSuccess() {
  debugMessage('onStopAppSuccess');
}

function sessionListener(e) {
  debugMessage('New session ID:' + e.sessionId);
  session = e;
  session.addUpdateListener(sessionUpdateListener);  
  session.addMessageListener(namespace, receiverMessage);
}

function sessionUpdateListener(isAlive) {
  var message = isAlive ? 'Session Updated' : 'Session Removed';
  message += ': ' + session.sessionId;
  debugMessage(message);
  if (!isAlive) {
    session = null;
  }
};

function receiverMessage(namespace, message) {
  debugMessage("receiverMessage: "+namespace+", "+message);
};

function receiverListener(e) {
  if( e === 'available' ) {
    debugMessage("receiver found");
  }
  else {
    debugMessage("receiver list empty");
  }
}

function stopApp() {
  session.stop(onStopAppSuccess, onError);
}

function sendMessage(message) {
  if (session!=null) {
    session.sendMessage(namespace, message, onSuccess.bind(this, "Message sent: " + message), onError);
  }
  else {
    chrome.cast.requestSession(function(e) {
        session = e;
        session.sendMessage(namespace, message, onSuccess.bind(this, "Message sent: " + message), onError);
      }, onError);
  }
}

function debugMessage(message) {
  console.log(message);
};

//
// Begin of my code
//

var eventQueue = [];
var queuePointer = 0;
var intervalFlag = null;

function simpleDateFormatter(jsondt) {
  var dt = jsondt.slice(0, 19).replace('T', ' ');
  return dt;
}


function updateEvent(data) {
  eventQueue = [];
  for(var id in data) {
    var x = data[id];
    eventQueue.push({
      'dt': x['start'],
      'content': x['title'] + '<br>\n' +
      '<span style="font-size:32px;">'+x['location'] + '</span><br>\n' +
      '<span style="font-size:24px;">'+simpleDateFormatter(x['start'])+'</span>'});
  }

  eventQueue.sort(function (a, b) { // ascendant order
    if(a['dt'] < b['dt']) return -1;
    if(a['dt'] > b['dt']) return 1;
    return 0;
  });
  queuePointer = 0;
  update();
  intervalFlag = setInterval(update, 5000);
}

function update() {
  msg = eventQueue[queuePointer % eventQueue.length].content;
  $('#input').html(msg);
  sendMessage(msg);
  queuePointer++;
}

var now = Date.now();
function newsTooOld(jsondt) {
  // One week = too old
  return Date.parse(jsondt) < now - 1000*86400*7;
}

function shortMessage(msg) {
  // Show 140 characters? XDDD
  if(msg.length > 140) {
    return msg.slice(0, 139) + '...';
  } else {
    return msg;
  }
}

function updateNews(data) {
  eventQueue = [];
  for(var reporter in data) {
    for(var i = 0; i < data[reporter]['post'].length; i++) {
      var x = data[reporter]['post'][i];
      if(!newsTooOld(x['datetime'])) {
        eventQueue.push({
          'dt': x['datetime'],
          'content': 
            '<span style="font-size:16px;">' + simpleDateFormatter(x['datetime']) + '</span><br>\n' +
            '<span style="font-size:24px;">' + shortMessage(x['message']) + '</span><br>\n' +
            '<img src="'+x['picture']+'">'});
      }
    }
  }

  if(eventQueue.length == 0) {  // When news is way too old ...
    return false;
  }

  eventQueue.sort(function (a, b) { // ascendant order
    if(a['dt'] < b['dt']) return -1;
    if(a['dt'] > b['dt']) return 1;
    return 0;
  });
  queuePointer = 0;
  update();
  intervalFlag = setInterval(update, 5000);
}



function loadEvents() {
  debugMessage('Loading events');
  if(intervalFlag != null) {
    debugMessage('Clear interval');
    clearInterval(intervalFlag);
  }
  $('#input').html("載入中...");
  $.ajax({
    url: 'https://livelink.firebaseio.com/event/.json',
    type: 'GET',
    dataType: 'json',
    cache: false,
    success: updateEvent,
    error: function(e) {
      debugMessage('Error reading JSON: ' + str(e));
    },
  });
}

function loadNews() {
  debugMessage('Loading news');
  if(intervalFlag != null) {
    debugMessage('Clear interval');
    clearInterval(intervalFlag);
  }
  $('#input').html("載入中...");
  $.ajax({
    url: 'https://livelink.firebaseio.com/news/.json',
    type: 'GET',
    dataType: 'json',
    cache: false,
    success: updateNews,
    error: function(e) {
      debugMessage('Error reading JSON: ' + str(e));
    },
  });
}
</script>
</head>
<body>
  <div>
    <input type="button" id="event" value="事件" onClick="loadEvents();" />
    <input type="button" id="news" value="報導"  onClick="loadNews();" />
  </div>
  <table id="wrapper">
  <tr>
    <td>
      <div id="input" class="border">
      事件
      </div>
    </td>
  </tr>
  </table>  

<script type="text/javascript">
loadEvents();
</script>
</body>
</html>
